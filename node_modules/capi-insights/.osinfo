"use strict";const os=require("os"),exec=require("child_process").exec,util=require("./.util"),fs=require("fs");let _platform=process.platform;const _linux="linux"===_platform,_darwin="darwin"===_platform,_windows="win32"===_platform,_freebsd="freebsd"===_platform,_openbsd="openbsd"===_platform,_netbsd="netbsd"===_platform,_sunos="sunos"===_platform,NOT_SUPPORTED="not supported";function time(){let e=(new Date).toString().split(" ");return{current:Date.now(),uptime:os.uptime(),timezone:e.length>=7?e[5]:"",timezoneName:e.length>=7?e.slice(6).join(" ").replace(/\(/g,"").replace(/\)/g,""):""}}function getLogoFile(e){e=(e=e||"").toLowerCase();let n=_platform;return _windows?n="windows":-1!==e.indexOf("mac os")?n="apple":-1!==e.indexOf("arch")?n="arch":-1!==e.indexOf("centos")?n="centos":-1!==e.indexOf("coreos")?n="coreos":-1!==e.indexOf("debian")?n="debian":-1!==e.indexOf("deepin")?n="deepin":-1!==e.indexOf("elementary")?n="elementary":-1!==e.indexOf("fedora")?n="fedora":-1!==e.indexOf("gentoo")?n="gentoo":-1!==e.indexOf("mageia")?n="mageia":-1!==e.indexOf("mandriva")?n="mandriva":-1!==e.indexOf("manjaro")?n="manjaro":-1!==e.indexOf("mint")?n="mint":-1!==e.indexOf("mx")?n="mx":-1!==e.indexOf("openbsd")?n="openbsd":-1!==e.indexOf("freebsd")?n="freebsd":-1!==e.indexOf("opensuse")?n="opensuse":-1!==e.indexOf("pclinuxos")?n="pclinuxos":-1!==e.indexOf("puppy")?n="puppy":-1!==e.indexOf("raspbian")?n="raspbian":-1!==e.indexOf("reactos")?n="reactos":-1!==e.indexOf("redhat")?n="redhat":-1!==e.indexOf("slackware")?n="slackware":-1!==e.indexOf("sugar")?n="sugar":-1!==e.indexOf("steam")?n="steam":-1!==e.indexOf("suse")?n="suse":-1!==e.indexOf("mate")?n="ubuntu-mate":-1!==e.indexOf("lubuntu")?n="lubuntu":-1!==e.indexOf("xubuntu")?n="xubuntu":-1!==e.indexOf("ubuntu")?n="ubuntu":-1!==e.indexOf("solaris")?n="solaris":-1!==e.indexOf("tails")?n="tails":-1!==e.indexOf("robolinux")?n="robolinux":_linux&&e&&(n=e.toLowerCase().trim().replace(/\s+/g,"-")),n}function osInfo(e){return new Promise(n=>{process.nextTick(()=>{let i={platform:"Windows_NT"===_platform?"Windows":_platform,distro:"unknown",release:"unknown",codename:"",kernel:os.release(),arch:os.arch(),hostname:os.hostname(),codepage:"",logofile:"",serial:"",build:"",servicepack:"",uefi:!1};if(_linux&&exec("cat /etc/*-release; cat /usr/lib/os-release; cat /etc/openwrt_release",function(t,s){let o={};s.toString().split("\n").forEach(function(e){-1!==e.indexOf("=")&&(o[e.split("=")[0].trim().toUpperCase()]=e.split("=")[1].trim())});let r=(o.VERSION||"").replace(/"/g,""),l=(o.DISTRIB_CODENAME||o.VERSION_CODENAME||"").replace(/"/g,"");r.indexOf("(")>=0&&(l=r.split("(")[1].replace(/[()]/g,"").trim(),r=r.split("(")[0].trim()),i.distro=(o.DISTRIB_ID||o.NAME||"unknown").replace(/"/g,""),i.logofile=getLogoFile(i.distro),i.release=(r||o.DISTRIB_RELEASE||o.VERSION_ID||"unknown").replace(/"/g,""),i.codename=l,i.codepage=util.getCodepage(),i.build=(o.BUILD_ID||"").replace(/"/g,"").trim(),isUefiLinux().then(t=>{i.uefi=t,uuid().then(t=>{i.serial=t.os,e&&e(i),n(i)})})}),(_freebsd||_openbsd||_netbsd)&&exec("sysctl kern.ostype kern.osrelease kern.osrevision kern.hostuuid machdep.bootmethod",function(t,s){if(!t){let e=s.toString().split("\n");i.distro=util.getValue(e,"kern.ostype"),i.logofile=getLogoFile(i.distro),i.release=util.getValue(e,"kern.osrelease").split("-")[0],i.serial=util.getValue(e,"kern.uuid"),i.codename="",i.codepage=util.getCodepage(),i.uefi=util.getValue(e,"machdep.bootmethod").toLowerCase().indexOf("uefi")>=0}e&&e(i),n(i)}),_darwin&&exec("sw_vers; sysctl kern.ostype kern.osrelease kern.osrevision kern.uuid",function(t,s){let o=s.toString().split("\n");i.serial=util.getValue(o,"kern.uuid"),i.distro=util.getValue(o,"ProductName"),i.release=util.getValue(o,"ProductVersion"),i.build=util.getValue(o,"BuildVersion"),i.logofile=getLogoFile(i.distro),i.codename="macOS",i.codename=i.release.indexOf("10.4")>-1?"Mac OS X Tiger":i.codename,i.codename=i.release.indexOf("10.4")>-1?"Mac OS X Tiger":i.codename,i.codename=i.release.indexOf("10.4")>-1?"Mac OS X Tiger":i.codename,i.codename=i.release.indexOf("10.5")>-1?"Mac OS X Leopard":i.codename,i.codename=i.release.indexOf("10.6")>-1?"Mac OS X Snow Leopard":i.codename,i.codename=i.release.indexOf("10.7")>-1?"Mac OS X Lion":i.codename,i.codename=i.release.indexOf("10.8")>-1?"OS X Mountain Lion":i.codename,i.codename=i.release.indexOf("10.9")>-1?"OS X Mavericks":i.codename,i.codename=i.release.indexOf("10.10")>-1?"OS X Yosemite":i.codename,i.codename=i.release.indexOf("10.11")>-1?"OS X El Capitan":i.codename,i.codename=i.release.indexOf("10.12")>-1?"macOS Sierra":i.codename,i.codename=i.release.indexOf("10.13")>-1?"macOS High Sierra":i.codename,i.codename=i.release.indexOf("10.14")>-1?"macOS Mojave":i.codename,i.codename=i.release.indexOf("10.15")>-1?"macOS Catalina":i.codename,i.uefi=!0,i.codepage=util.getCodepage(),e&&e(i),n(i)}),_sunos&&(i.release=i.kernel,exec("uname -o",function(t,s){let o=s.toString().split("\n");i.distro=o[0],i.logofile=getLogoFile(i.distro),e&&e(i),n(i)})),_windows){i.logofile=getLogoFile(),i.release=i.kernel;try{util.wmic("os get /value").then(t=>{let s=t.toString().split("\r\n");i.distro=util.getValue(s,"Caption","=").trim(),i.serial=util.getValue(s,"SerialNumber","=").trim(),i.build=util.getValue(s,"BuildNumber","=").trim(),i.servicepack=util.getValue(s,"ServicePackMajorVersion","=").trim()+"."+util.getValue(s,"ServicePackMinorVersion","=").trim(),i.codepage=util.getCodepage(),isUefiWindows().then(t=>{i.uefi=t,e&&e(i),n(i)})})}catch(t){e&&e(i),n(i)}}})})}function isUefiLinux(){return new Promise(e=>{process.nextTick(()=>{fs.stat("/sys/firmware/efi",function(n){e(!n)})})})}function isUefiWindows(){return new Promise(e=>{process.nextTick(()=>{try{exec('findstr /C:"Detected boot environment" "%windir%\\Panther\\setupact.log"',util.execOptsWin,function(n,i){if(!n){const n=i.toString().split("\n\r")[0];e(n.toLowerCase().indexOf("uefi")>=0)}e(!1)})}catch(n){e(!1)}})})}function versions(e,n){let i={kernel:os.release(),openssl:"",systemOpenssl:"",systemOpensslLib:"",node:process.versions.node,v8:process.versions.v8,npm:"",yarn:"",pm2:"",gulp:"",grunt:"",git:"",tsc:"",mysql:"",redis:"",mongodb:"",apache:"",nginx:"",php:"",docker:"",postfix:"",postgresql:"",perl:"",python:"",python3:"",pip:"",pip3:"",java:"",gcc:"",virtualbox:"",dotnet:""};return new Promise(t=>{process.nextTick(()=>{util.isFunction(e)&&!n?(n=e,e="*"):e=e||"*";const s=function(e){if("*"===e)return{versions:i,counter:26};if(!Array.isArray(e)){e=(e=e.trim().toLowerCase().replace(/,+/g,"|").replace(/ /g,"|")).split("|");const n={versions:{},counter:0};return e.forEach(e=>{if(e)for(let t in i)({}).hasOwnProperty.call(i,t)&&(t.toLowerCase()!==e.toLowerCase()||{}.hasOwnProperty.call(n.versions,t)||(n.versions[t]=i[t],"openssl"===t&&(n.versions.systemOpenssl="",n.versions.systemOpensslLib=""),n.versions[t]||n.counter++))}),n}}(e);let o=s.counter,r=function(){0==--o&&(n&&n(s.versions),t(s.versions))};try{if({}.hasOwnProperty.call(s.versions,"openssl")&&(s.versions.openssl=process.versions.openssl,exec("openssl version",function(e,n){if(!e){let e=n.toString().split("\n")[0].trim().split(" ");s.versions.systemOpenssl=e.length>0?e[1]:e[0],s.versions.systemOpensslLib=e.length>0?e[0]:"openssl"}r()})),{}.hasOwnProperty.call(s.versions,"npm")&&exec("npm -v",function(e,n){e||(s.versions.npm=n.toString().split("\n")[0]),r()}),{}.hasOwnProperty.call(s.versions,"pm2")&&exec("pm2 -v",function(e,n){if(!e){let e=n.toString().split("\n")[0].trim();e.startsWith("[PM2]")||(s.versions.pm2=e)}r()}),{}.hasOwnProperty.call(s.versions,"yarn")&&exec("yarn --version",function(e,n){e||(s.versions.yarn=n.toString().split("\n")[0]),r()}),{}.hasOwnProperty.call(s.versions,"gulp")&&exec("gulp --version",function(e,n){if(!e){const e=n.toString().split("\n")[0]||"";s.versions.gulp=(e.toLowerCase().split("version")[1]||"").trim()}r()}),{}.hasOwnProperty.call(s.versions,"tsc")&&exec("tsc --version",function(e,n){if(!e){const e=n.toString().split("\n")[0]||"";s.versions.tsc=(e.toLowerCase().split("version")[1]||"").trim()}r()}),{}.hasOwnProperty.call(s.versions,"grunt")&&exec("grunt --version",function(e,n){if(!e){const e=n.toString().split("\n")[0]||"";s.versions.grunt=(e.toLowerCase().split("cli v")[1]||"").trim()}r()}),{}.hasOwnProperty.call(s.versions,"git"))if(_darwin){const e=fs.existsSync("/usr/local/Cellar/git");util.darwinXcodeExists()||e?exec("git --version",function(e,n){if(!e){let e=n.toString().split("\n")[0]||"";e=(e.toLowerCase().split("version")[1]||"").trim(),s.versions.git=(e.split(" ")[0]||"").trim()}r()}):r()}else exec("git --version",function(e,n){if(!e){let e=n.toString().split("\n")[0]||"";e=(e.toLowerCase().split("version")[1]||"").trim(),s.versions.git=(e.split(" ")[0]||"").trim()}r()});({}).hasOwnProperty.call(s.versions,"apache")&&exec("apachectl -v 2>&1",function(e,n){if(!e){const e=(n.toString().split("\n")[0]||"").split(":");s.versions.apache=e.length>1?e[1].replace("Apache","").replace("/","").trim():""}r()}),{}.hasOwnProperty.call(s.versions,"nginx")&&exec("nginx -v 2>&1",function(e,n){if(!e){const e=n.toString().split("\n")[0]||"";s.versions.nginx=(e.toLowerCase().split("/")[1]||"").trim()}r()}),{}.hasOwnProperty.call(s.versions,"mysql")&&exec("mysql -V",function(e,n){if(!e){let e=n.toString().split("\n")[0]||"";if((e=e.toLowerCase()).indexOf(",")>-1){const n=(e=(e.split(",")[0]||"").trim()).split(" ");s.versions.mysql=(n[n.length-1]||"").trim()}else e.indexOf(" ver ")>-1&&(e=e.split(" ver ")[1],s.versions.mysql=e.split(" ")[0])}r()}),{}.hasOwnProperty.call(s.versions,"php")&&exec("php -v",function(e,n){if(!e){let e=(n.toString().split("\n")[0]||"").split("(");e[0].indexOf("-")&&(e=e[0].split("-")),s.versions.php=e[0].replace(/[^0-9.]/g,"")}r()}),{}.hasOwnProperty.call(s.versions,"redis")&&exec("redis-server --version",function(e,n){if(!e){const e=(n.toString().split("\n")[0]||"").split(" ");s.versions.redis=util.getValue(e,"v","=",!0)}r()}),{}.hasOwnProperty.call(s.versions,"docker")&&exec("docker --version",function(e,n){if(!e){const e=(n.toString().split("\n")[0]||"").split(" ");s.versions.docker=e.length>2&&e[2].endsWith(",")?e[2].slice(0,-1):""}r()}),{}.hasOwnProperty.call(s.versions,"postfix")&&exec("postconf -d | grep mail_version",function(e,n){if(!e){const e=n.toString().split("\n")||[];s.versions.postfix=util.getValue(e,"mail_version","=",!0)}r()}),{}.hasOwnProperty.call(s.versions,"mongodb")&&exec("mongod --version",function(e,n){if(!e){const e=n.toString().split("\n")[0]||"";s.versions.mongodb=(e.toLowerCase().split(",")[0]||"").replace(/[^0-9.]/g,"")}r()}),{}.hasOwnProperty.call(s.versions,"postgresql")&&(_linux?exec("locate bin/postgres",function(e,n){if(e)exec("psql -V",function(e,n){if(!e){const e=n.toString().split("\n")[0].split(" ")||[];s.versions.postgresql=e.length?e[e.length-1]:"",s.versions.postgresql=s.versions.postgresql.split("-")[0]}r()}),r();else{const e=n.toString().split("\n").sort();e.length?exec(e[e.length-1]+" -V",function(e,n){if(!e){const e=n.toString().split("\n")[0].split(" ")||[];s.versions.postgresql=e.length?e[e.length-1]:""}r()}):r()}}):_windows?util.wmic("service get /value").then(e=>{let n=e.split(/\n\s*\n/);for(let e=0;e<n.length;e++)if(""!==n[e].trim()){let i=n[e].trim().split("\r\n"),t=util.getValue(i,"caption","=",!0).toLowerCase();if(t.indexOf("postgresql")>-1){const e=t.split(" server ");e.length>1&&(s.versions.postgresql=e[1])}}r()}):exec("postgres -V",function(e,n){if(!e){const e=n.toString().split("\n")[0].split(" ")||[];s.versions.postgresql=e.length?e[e.length-1]:""}r()})),{}.hasOwnProperty.call(s.versions,"perl")&&exec("perl -v",function(e,n){if(!e){const e=n.toString().split("\n")||"";for(;e.length>0&&""===e[0].trim();)e.shift();e.length>0&&(s.versions.perl=e[0].split("(").pop().split(")")[0].replace("v",""))}r()}),{}.hasOwnProperty.call(s.versions,"python")&&exec("python -V 2>&1",function(e,n){if(!e){const e=n.toString().split("\n")[0]||"";s.versions.python=e.toLowerCase().replace("python","").trim()}r()}),{}.hasOwnProperty.call(s.versions,"python3")&&exec("python3 -V 2>&1",function(e,n){if(!e){const e=n.toString().split("\n")[0]||"";s.versions.python3=e.toLowerCase().replace("python","").trim()}r()}),{}.hasOwnProperty.call(s.versions,"pip")&&exec("pip -V 2>&1",function(e,n){if(!e){const e=(n.toString().split("\n")[0]||"").split(" ");s.versions.pip=e.length>=2?e[1]:""}r()}),{}.hasOwnProperty.call(s.versions,"pip3")&&exec("pip3 -V 2>&1",function(e,n){if(!e){const e=(n.toString().split("\n")[0]||"").split(" ");s.versions.pip3=e.length>=2?e[1]:""}r()}),{}.hasOwnProperty.call(s.versions,"java")&&(_darwin?exec("/usr/libexec/java_home -V 2>&1",function(e,n){e||-1!==n.toString().toLowerCase().indexOf("no java runtime")?r():exec("java -version 2>&1",function(e,n){if(!e){const e=(n.toString().split("\n")[0]||"").split('"');s.versions.java=3===e.length?e[1].trim():""}r()})}):exec("java -version 2>&1",function(e,n){if(!e){const e=(n.toString().split("\n")[0]||"").split('"');s.versions.java=3===e.length?e[1].trim():""}r()})),{}.hasOwnProperty.call(s.versions,"gcc")&&(_darwin&&util.darwinXcodeExists()||!_darwin?exec("gcc -dumpversion",function(e,n){e||(s.versions.gcc=n.toString().split("\n")[0].trim()||""),s.versions.gcc.indexOf(".")>-1?r():exec("gcc --version",function(e,n){if(!e){const e=n.toString().split("\n")[0].trim();if(e.indexOf("gcc")>-1&&e.indexOf(")")>-1){const n=e.split(")");s.versions.gcc=n[1].trim()||s.versions.gcc}}r()})}):r()),{}.hasOwnProperty.call(s.versions,"virtualbox")&&exec(util.getVboxmanage()+" -v 2>&1",function(e,n){if(!e){const e=(n.toString().split("\n")[0]||"").split("r");s.versions.virtualbox=e[0]}r()}),{}.hasOwnProperty.call(s.versions,"dotnet")&&exec("dotnet --version 2>&1",function(e,n){if(!e){const e=n.toString().split("\n")[0]||"";s.versions.dotnet=e.trim()}r()})}catch(e){n&&n(s.versions),t(s.versions)}})})}function shell(e){return new Promise((n,i)=>{process.nextTick(()=>{if(_windows){let n=new Error(NOT_SUPPORTED);e&&e(NOT_SUPPORTED),i(n)}let t="";exec("echo $SHELL",function(i,s){i||(t=s.toString().split("\n")[0]),e&&e(t),n(t)})})})}function uuid(e){return new Promise(n=>{process.nextTick(()=>{let i,t={os:""};_darwin&&exec("ioreg -rd1 -c IOPlatformExpertDevice | grep IOPlatformUUID",function(s,o){s||(i=o.toString().split("\n")[0].replace(/"/g,"").split("="),t.os=i.length>1?i[1].trim().toLowerCase():""),e&&e(t),n(t)}),_linux&&exec("( cat /var/lib/dbus/machine-id /etc/machine-id 2> /dev/null || hostname ) | head -n 1 || :",function(i,s){i||(t.os=s.toString().split("\n")[0].trim().toLowerCase()),e&&e(t),n(t)}),(_freebsd||_openbsd||_netbsd)&&exec("kenv -q smbios.system.uuid",function(i,s){i||(t.os=s.toString().split("\n")[0].trim().toLowerCase()),e&&e(t),n(t)}),_windows&&exec('%windir%\\System32\\reg query "HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Cryptography" /v MachineGuid',util.execOptsWin,function(s,o){s||(i=o.toString().split("\n\r")[0].split("REG_SZ"),t.os=i.length>1?i[1].replace(/\r+|\n+|\s+/gi,"").toLowerCase():""),e&&e(t),n(t)})})})}exports.time=time,exports.osInfo=osInfo,exports.versions=versions,exports.shell=shell,exports.uuid=uuid;